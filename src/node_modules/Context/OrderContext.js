import React, { createContext, useContext, useState } from "react";
import toast, { Toaster } from "react-hot-toast";

const OrderContext = createContext();

const OrderContextProvider = (props) => {
  let [cartItems, setCartItems] = useState([]);
  let [totalPrice, setTotalPrice] = useState(0);
  let [qty, setQty] = useState(1);

  const onAdd = (product, quantity = 1) => {
    const itemIndex = cartItems.findIndex((value) => value.id === product.id);

    if (itemIndex < 0) {
      const newProduct = {
        ...product,
        quantity: quantity,
      };
      setCartItems([...cartItems, newProduct]);
      setTotalPrice(
        (prevTotalPrice) =>
          +prevTotalPrice + +(newProduct.price * newProduct.quantity)
      );
      toast.success(`${product.title} добавлен в корзину.`);
    }
  };

  const onDelete = (vendorCode, qty) => {
    const deletedItem = cartItems.find((item) => item.vendorCode == vendorCode);
    const newCart = cartItems.filter((item) => item !== deletedItem);
    setCartItems(newCart);
    setTotalPrice(
      (prevTotalPrice) => +prevTotalPrice - +deletedItem.price * qty
    );
  };

  const handlePlus = (id) => {
    setQty((prevQty) => prevQty + 1);
  };

  const handleMinus = (id) => {
    setQty((prevQty) => {
      return prevQty - 1;
    });
  };

  const onClearCart = () => {
    setCartItems((prevItems) => (prevItems.length = 0));
  };

  const value = {
    items: cartItems,
    onClearCart: onClearCart,
    onAdd: onAdd,
    onDelete: onDelete,
    qty: qty,
    totalPrice: totalPrice,
    setTotalPrice: setTotalPrice,
  };

  return (
    <OrderContext.Provider value={value}>
      <div>
        <Toaster position="bottom-center" />
      </div>
      {props.children}
    </OrderContext.Provider>
  );
};

export { OrderContext, OrderContextProvider };
